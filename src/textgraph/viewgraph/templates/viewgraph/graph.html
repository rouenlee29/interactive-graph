<!-- https://stackoverflow.com/questions/18586921/how-to-launch-html-using-chrome-at-allow-file-access-from-files-mode -->
<!DOCTYPE html>
<meta charset="utf-8">
<style>

:root {
  --x-offset:60px;
}

.links line {
  stroke: rgb(15, 15, 15);
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

.svg-container {
    display: inline-block;
    position: relative;
    width: 100%;
    padding-bottom: 100%;
    vertical-align: top;
    overflow: hidden;
    z-index: -1;
}
.svg-content {
    display: inline-block;
    position: absolute;
    top: 0;
    left: 0;
}
.overlay {
  /* display: inline-block;
    position: relative;
    width: 100%;
    padding-bottom: 100%;
    vertical-align: top;
    overflow: hidden; */
    position: absolute;
    top: 5px;
    left: var(--x-offset);
}


</style>

<body>
<div id="container" class="svg-container">
    
    
    <svg></svg>
    
    
</div>

<div class = "overlay">
    <h1>Helllllllllllllllloooooooooooooooo</h1>
    <form action="/selection" method="get">
      <input type="checkbox" name="movie4" value=4>
      <label for="movie4">Alice in Wonderland</label><br>
      
      <input type="checkbox" name="movie12" value=12>
      <label for="movie12">Black Swan</label><br>

      <input type="checkbox" name="movie557" value=557>
      <label for="movie557">The Oranges</label><br>
      
      <input type="checkbox" name="movie15" value=15>
      <label for="movie15">The Bounty Hunter</label><br>

      <input type="checkbox" name="movie1070" value=1070>
      <label for="movie1070">The Skeleton Twins</label><br>

      <input type="checkbox" name="movie22" value=22>
      <label for="movie22">Charlie St. Cloud</label><br>

      <input type="checkbox" name="movie564" value=564>
      <label for="movie564">The Perks of Being a Wallflower</label><br>

      <input type="checkbox" name="movie25" value=25>
      <label for="movie25">Clash of the Titans</label><br>

      <input type="checkbox" name="movie39" value=39>
      <label for="movie39">Despicable Me</label><br>

      <input type="checkbox" name="movie41" value=41>
      <label for="movie41">Diary of a Wimpy Kid</label><br>

      <input type="checkbox" name="movie106" value=106>
      <label for="movie106">Little Fockers</label><br>

      <input type="checkbox" name="movie43" value=43>
      <label for="movie43">Dirty Girl</label><br>
      
      <input type="checkbox" name="movie47" value=47>
      <label for="movie47">The Twilight Saga</label><br>
      <br>
      <input type="submit" value="Submit">  
    </form>
</div>

  
<!-- <svg width="1800" height="1000"> -->


<script src="https://d3js.org/d3.v4.min.js"></script>
{% load static %}
<script src="{% static "viewgraph/js/node-pie.js" %}"></script>
<script>

var style = getComputedStyle(document.body);
const textAlignment_x = parseInt(style.getPropertyValue('--x-offset'), 10);


const viewBox_x = "1800";
const viewBox_y = "900";
var svg = d3.select("div#container")
  .append("svg")
  .attr("preserveAspectRatio", "xMinYMin meet")
  .attr("viewBox", `0 0 ${viewBox_x} ${viewBox_y}`)
  .classed("svg-content", true);
// var svg = d3.select("svg"),
    // width = +svg.attr("width"),
    // height = +svg.attr("height");
    width = parseInt(viewBox_x,10);
    height = parseInt(viewBox_y,10);
    


var simulation = d3.forceSimulation()
    .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(120))
    .force("charge", d3.forceManyBody().strength(-500).distanceMax(height/2))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .velocityDecay(0.9)
    .alphaTarget(0.5)
    ;

var graph = JSON.parse("{{data|escapejs}}"); 

const colorMapping = {
    
    "horror/mystery" : "#64503f",
    "drama" : "#b19cd9", 
    "romance" : "#ff9fb6",
    "action/adventure/thriller" : "#ff4c42", 
    "musical" : "#ffb347", 
    "comedy" : "#8be28b", 
    "family" : "#009999", 
    "sciencefiction/fantasy" : "#1240AB",  
    "animation" : "#7ea4b3", 
    "biography/documentary" : "#adad9a", 
}

let defaultCheckBoxesContent = "{{ check_boxes_html|escapejs }}";



const defaultStrokeWidth = 2;
const defaultSrokeColor = '#b8b8b8';

var link = svg.append("g")
  .attr("class", "links")
  .selectAll("line")
  .data(graph.links)
  .enter().append("line")
  .style('stroke', defaultSrokeColor)
  .attr("stroke-width", function(d) { return defaultStrokeWidth; })
  .attr("stroke-opacity", function(d) { return d.value; });

// add background glow
var defs = svg.append("defs");

var filter = defs.append("filter")
.attr("id","glow");

filter.append("feMorphology")
  .attr("operator", "dilate")
  .attr("radius", "4")
  .attr("in", "SourceGraphic")
  .attr("result", "thicken");

filter.append("feGaussianBlur")
  .attr("in", "thicken")
  .attr("class", "blur")
  .attr("stdDeviation","20")
  .attr("result","coloredBlur");
  

filter.append("feFlood").attr("flood-color", "rgb(255, 255, 0)")
.attr("result", "glowColor");

filter.append("feComposite").attr("in", "glowColor")
  .attr("in2", "coloredBlur")
  .attr("operator", "in")
  .attr("result", "softGlow_colored")

// filter.append("feGaussianBlur").attr("in", "thicken")
// .attr("result", "blurred");

var feMerge = filter.append("feMerge");
feMerge.append("feMergeNode")
  .attr("in","softGlow_colored");
feMerge.append("feMergeNode")
  .attr("in","SourceGraphic");

var node = svg.append("g")
  .attr("class", "nodes")
  .selectAll("g")
  .data(graph.nodes)
  .enter().append("g");

defaultInstructions = ""
node.on('mouseover', function (d, i) {
        simulation.stop()
        
        // make check boxes disappear, and legend appear
        // checkBoxes.html("");
        legendLabels.attr("visibility", "visible")
        legendDots.attr("visibility", "visible")

        d3.select(this).transition()
              .duration('50')
              .attr('opacity', '.50');
        
        link
          .style('stroke', function (link_d) { 
            return link_d.source_idx === d.idx || link_d.target_idx === d.idx ? '#FFF373' : defaultSrokeColor;})
          .style('stroke-width', function (link_d) { 
            return link_d.source_idx === d.idx || link_d.target_idx === d.idx ? 4 : defaultStrokeWidth;})

        let related_idx = [];
        graph.links.forEach(function(item, index){
            if (item.source_idx === d.idx || item.target_idx == d.idx){
              related_idx.push(item.source_idx === d.idx ? item.target_idx : item.source_idx)
            };
        })

        // make linked nodes have a glow 
        node
            .style('filter', function(node_d){
              return related_idx.includes(node_d.idx) ? "url(#glow)" : "none" 
        })
            
        svgText.text(d.id);
        svgDescription.html(d.description);

    })
    .on('mouseout', function (d, i) {
        // make check boxes appear, and legend disappear
        // checkBoxes.html(defaultCheckBoxesContent);
        legendLabels.attr("visibility", "hidden")
        legendDots.attr("visibility", "hidden")

        d3.select(this).transition()
              .duration('50')
              .attr('opacity', '1');

        link
          .style('stroke', 'b8b8b8')
          .style('stroke-width', '2')
          .attr("stroke-opacity", function(d) { return d.value; });
        
        node.style('filter','none');

        //d3.select('#tools').remove();
        svgText.text(defaultInstructions);
        // svgDescription.text(defaultDescription);
        svgDescription.html(defaultDescription);

        // svgDescription2.html("<h1>hey you changed me!!!!</h1>")

        simulation.alpha(1);
        simulation.restart();
    })
  .call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended));


var color = d3.scaleOrdinal(d3.schemeCategory10);

function createPieData(d){
    let pieData = [];
    for (let i = 0; i < d.genre.length; i++){
        var pieDict = {};
        pieDict['color'] = colorMapping[d.genre[i]]
        pieDict['percent'] = 100 / d.genre.length;
        pieData.push(pieDict);
    }
    // console.log(pieData)

    return pieData;
};

/* Draw the respective pie chart for each node */
node.each(function (d) {
          NodePieBuilder.drawNodePie(d3.select(this),
          createPieData(d), 
          {
              parentNodeColor: color(1),
              outerStrokeWidth: 12,
              labelColor: color(1)
          });
      });

var labels = node.append("text")
    .text(function(d) {
      return d.id;
    })
    .attr('idx', function(d){return d.idx;})
    .attr('x', 6)
    .attr('y', 3)
    .attr('font-family', 'sans-serif')
    .attr('font-size', '10px');

node.append("title")
    .text(function(d) { return d.id; });

simulation
    .nodes(graph.nodes)
    .on("tick", ticked);

simulation.force("link")
  .links(graph.links);
    
function ticked() {
  link
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  node
      .attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      })
};
// });

function dragstarted(d) {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended(d) {
  if (!d3.event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

// add text box
const textBoxWidth = 280;
const textBoxHeight = viewBox_y;
const textBoxOpacity = '.90'
function generateTextBox(x){
  var textBox = svg.append("rect")
            .attr("x", x)
            .attr("y", 0)
            .attr("width", textBoxWidth)
            .attr("height", textBoxHeight)
            .attr('opacity', textBoxOpacity)
            .attr("fill", "white");
}
generateTextBox(textAlignment_x);

if ("{{ show_all_checkboxes|escapejs }}"){
  for (i = 1; i < 6; i++){
    generateTextBox(textAlignment_x + (textBoxWidth) * i);
  }
  const defaultInstructions = ""
} else {
  const defaultInstructions = "Hover over node to view movie description"
}

// add legend title
const legendStart_y = 400;

// add dots in legend
const betweenLegendElements_y = 20;
var legendDots = svg.selectAll("mydots")
  .data(Object.keys(colorMapping))
  .enter()
  .append("circle")
    .attr("cx", textAlignment_x)
    .attr("cy", function(d,i){ return legendStart_y + 25 + i*betweenLegendElements_y}) 
    .attr("r", 5)
    .style("fill", function(d,i){return colorMapping[d]})
    .attr("visibility", "hidden");

// add labels
var legendLabels = svg.selectAll("mylabels")
  .data(Object.keys(colorMapping))
  .enter()
  .append("text")
    .attr("x", textAlignment_x + 20)
    .attr("y", function(d,i){ return legendStart_y +30 + i*betweenLegendElements_y}) 
    .style("fill", function(d,i){return colorMapping[d]})
    .text(function(d){ return d})
    .attr("text-anchor", "left")
    .attr("font-family", "Georgia")
    .attr("font-size", "15px")
    .style("alignment-baseline", "middle")
    .attr("visibility", "hidden");
    

// Instructions for user
var svgText = svg.append("text");
svgText
  .attr("x",textAlignment_x)
  .attr("y",50)
  .attr("font-family", "Georgia");

svgText.text(defaultInstructions);

const defaultDescription = ""

const descriptionTextStart = 70;
var svgDescription = svg.append("foreignObject")
    .attr("x",textAlignment_x)
    .attr("y",descriptionTextStart)
    .attr("width", textBoxWidth)
    .attr("height", 300)
    .append("xhtml:svg")
    .style("font", "13px 'Georgia Neue'")
    .style("font-style", "italic")
    .text(defaultDescription)
    ;
    // .html("Lorem ipsum dolor sit  amet, consectetur adipiscing elit. Donec eu enim quam. Quisque nisi risus, sagittis quis tempor nec, aliquam eget neque. Nulla bibendum semper lorem non ullamcorper. Nulla non ligula lorem. Praesent porttitor, tellus nec suscipit aliquam, enim elit posuere lorem, at laoreet enim ligula sed tortor. Ut sodales, urna a aliquam semper, nibh diam gravida sapien, sit amet fermentum purus lacus eget massa. Donec ac arcu vel magna consequat pretium et vel ligula. Donec sit amet erat elit. Vivamus eu metus eget est hendrerit rutrum. Curabitur vitae orci et leo interdum egestas ut sit amet dui. In varius enim ut sem posuere in tristique metus ultrices.<p>Integer mollis massa at orci porta vestibulum. Pellentesque dignissim turpis ut tortor ultricies condimentum et quis nibh. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer euismod lorem vulputate dui pharetra luctus. Sed vulputate, nunc quis porttitor scelerisque, dui est varius ipsum, eu blandit mauris nibh pellentesque tortor. Vivamus ultricies ante eget ipsum pulvinar ac tempor turpis mollis. Morbi tortor orci, euismod vel sagittis ac, lobortis nec est. Quisque euismod venenatis felis at dapibus. Vestibulum dignissim nulla ut nisi tristique porttitor. Proin et nunc id arcu cursus dapibus non quis libero. Nunc ligula mi, bibendum non mattis nec, luctus id neque. Suspendisse ut eros lacus. Praesent eget lacus eget risus congue vestibulum. Morbi tincidunt pulvinar lacus sed faucibus. Phasellus sed vestibulum sapien.");

function generateCheckBoxes(x, html){
  var checkBoxes = svg.append("foreignObject")
    .attr("x",x)
    .attr("y",descriptionTextStart)
    .attr("width", textBoxWidth)
    .attr("height", 900)
    .append("xhtml:svg")
    .style("font", "13px 'Georgia Neue'")
    .style("font-style", "italic")
    .html(html)
}

// generateCheckBoxes(textAlignment_x, `<form action="/selection" method="get">
//     <input type="checkbox" name="movie0" value=0>
//     <label for="movie0">127 Hours</label><br>`);
  
// generateCheckBoxes(textAlignment_x + textBoxWidth, `<input type="checkbox" name="movie4" value=4>
//     <label for="movie4">Do not choose</label><br>
//     <br>
//     <input type="submit" value="Submit">

//     </form>`);



</script>

</body>



